<!doctype html>
<html>
  <head>
    <title>Generate Route - GPS Shape Runner</title>
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  </head>

  <body>
    <!-- Navigation Bar -->
    <nav>
      <a href="/">Home</a>
      <a href="/about">About</a>

      <% if (loggedInUser) { %>
        <a href="/routes/generate">Generate Route</a>
        <a href="/routes/search">My Routes</a>
        <a href="/runs/add">Log Run</a>
        <a href="/runs/search">My Runs</a>

        <span style="margin-left:auto;">
          <a href="/logout">Logout</a>
        </span>
      <% } else { %>
        <span style="margin-left:auto;">
          <a href="/login">Login</a>
          <a href="/register">Register</a>
        </span>
      <% } %>
    </nav>

    <div class="page">
      <h1>Generate a Shape Route</h1>

      <% if (error) { %>
        <div class="error"><%= error %></div>
      <% } %>

      <p id="geoStatus" class="muted"></p>

      <div class="card">
        <h3>Draw Your Shape</h3>
        <p class="muted">
          Click on the map to add points for your custom shape. Each click adds a
          point and joins it to the previous one. The first point is shown in
          yellow, the last point in orange, and middle points in red.
        </p>

        <div id="drawMap"></div>

        <button type="button" id="clearShapeBtn" class="secondary">Clear shape</button>
      </div>

      <div class="card">
        <h3>Route Settings</h3>
        <form method="POST" action="/routes/generate">
          <label>Shape (for preset mode, if you don't draw):
            <select name="shapeName">
              <option value="square" <%= form.shapeName === 'square' ? 'selected' : '' %>>Square</option>
              <option value="triangle" <%= form.shapeName === 'triangle' ? 'selected' : '' %>>Triangle</option>
            </select>
          </label>

          <label>Centre latitude:
            <input type="text" name="centerLat" value="<%= form.centerLat %>">
          </label>

          <label>Centre longitude:
            <input type="text" name="centerLng" value="<%= form.centerLng %>">
          </label>

          <label>Scale (km, used only for preset shapes):
            <input type="number" name="scaleKm" value="<%= form.scaleKm %>" step="0.5">
          </label>

          <!-- Hidden field that will contain the drawn points as JSON -->
          <input type="hidden" name="pointsJson" id="pointsJson">

          <p class="muted">
            If you draw at least two points on the map, your custom shape will be
            used to generate a road-snapped route. If you leave the map empty,
            the selected preset shape will be used instead.
          </p>

          <input type="submit" id="generateBtn" value="Generate Route" disabled>
        </form>
      </div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
      (function () {
        var statusEl = document.getElementById('geoStatus');
        var latInput = document.querySelector('input[name="centerLat"]');
        var lngInput = document.querySelector('input[name="centerLng"]');
        var pointsField = document.getElementById('pointsJson');
        var generateBtn = document.getElementById('generateBtn');
        var clearBtn = document.getElementById('clearShapeBtn');

        // Default center (London)
        var startLat = parseFloat(latInput.value) || 51.505;
        var startLng = parseFloat(lngInput.value) || -0.09;

        var map = L.map('drawMap').setView([startLat, startLng], 14);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        var drawnPoints = [];
        var markers = [];
        var polyline = L.polyline([], { color: 'red' }).addTo(map);

        function refreshMarkers() {
          for (var i = 0; i < markers.length; i++) {
            var color = 'red';

            if (i === 0 && markers.length > 0) {
              color = 'yellow'; // first point
            }
            if (i === markers.length - 1 && markers.length > 1) {
              color = 'orange'; // last point
            }

            markers[i].setStyle({
              color: color,
              fillColor: color,
              fillOpacity: 1
            });
            markers[i].bindPopup('Point ' + (i + 1));
          }
        }

        function updatePointsField() {
          var simplePoints = drawnPoints.map(function (p) {
            return { lat: p.lat, lng: p.lng };
          });
          pointsField.value = JSON.stringify(simplePoints);
          // Enable generate when at least 2 points exist
          generateBtn.disabled = simplePoints.length < 2;
        }

        map.on('click', function (e) {
          var marker = L.circleMarker(e.latlng, {
            radius: 5,
            color: 'red',
            fillColor: 'red',
            fillOpacity: 1
          }).addTo(map);

          drawnPoints.push(e.latlng);
          markers.push(marker);
          polyline.setLatLngs(drawnPoints);
          refreshMarkers();
          updatePointsField();
        });

        clearBtn.addEventListener('click', function () {
          drawnPoints = [];
          pointsField.value = '';
          generateBtn.disabled = true;
          polyline.setLatLngs([]);

          // Remove existing markers from map
          markers.forEach(function (m) {
            map.removeLayer(m);
          });
          markers = [];
        });

        // Geolocation to move map + centre inputs near the user
        if (!navigator.geolocation) {
          statusEl.textContent = 'Geolocation is not supported by this browser.';
        } else {
          statusEl.textContent = 'Trying to detect your location...';

          navigator.geolocation.getCurrentPosition(
            function (position) {
              var lat = position.coords.latitude;
              var lng = position.coords.longitude;

              latInput.value = lat.toFixed(5);
              lngInput.value = lng.toFixed(5);

              map.setView([lat, lng], 14);

              statusEl.textContent = 'Location detected. Click on the map to draw your shape.';
            },
            function (error) {
              console.log('Geolocation error:', error);
              statusEl.textContent = 'Could not get your location; using default centre.';
            }
          );
        }
      })();
    </script>
  </body>
</html>
